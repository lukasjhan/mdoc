import { X509Certificate } from '@peculiar/x509'
import { expect, suite, test } from 'vitest'
import { CoseKey, hex, Issuer, SignatureAlgorithm } from '../../src'
import { DEVICE_JWK, ISSUER_CERTIFICATE, ISSUER_PRIVATE_KEY_JWK } from '../config'
import { deterministicMdocContext } from '../context'

const signed = new Date('2023-10-24T14:55:18Z')
const validFrom = new Date(signed)
validFrom.setMinutes(signed.getMinutes() + 5)
const validUntil = new Date(signed)
validUntil.setFullYear(signed.getFullYear() + 30)

suite('Issuance', () => {
  test('Issue simple mdoc', async () => {
    const issuer = new Issuer('org.iso.18013.5.1', deterministicMdocContext)

    issuer.addIssuerNamespace('org.iso.18013.5.1.mDL', {
      first_name: 'First',
      last_name: 'Last',
    })

    const issuerSigned = await issuer.sign({
      signingKey: CoseKey.fromJwk(ISSUER_PRIVATE_KEY_JWK),
      certificate: new Uint8Array(new X509Certificate(ISSUER_CERTIFICATE).rawData),
      algorithm: SignatureAlgorithm.ES256,
      digestAlgorithm: 'SHA-256',
      deviceKeyInfo: { deviceKey: CoseKey.fromJwk(DEVICE_JWK) },
      validityInfo: { signed, validFrom, validUntil },
    })

    const claims = issuerSigned.getPrettyClaims('org.iso.18013.5.1.mDL')

    expect(claims).toMatchObject({
      first_name: 'First',
      last_name: 'Last',
    })

    expect(hex.encode(issuerSigned.encode())).toStrictEqual(
      'a26a6e616d65537061636573a1756f72672e69736f2e31383031332e352e312e6d444c82d8185868a46864696765737449441a9bdb72496672616e646f6d58209bdb72498967865710108af43959f90c1b6aac9687bedd1fa53dd0d2103fa5d071656c656d656e744964656e7469666965726a66697273745f6e616d656c656c656d656e7456616c7565654669727374d8185866a46864696765737449441a9bdb72496672616e646f6d58209bdb72498967865710108af43959f90c1b6aac9687bedd1fa53dd0d2103fa5d071656c656d656e744964656e746966696572696c6173745f6e616d656c656c656d656e7456616c7565644c6173746a697373756572417574688443a10126a2182159022e3082022a308201d0a003020102021457c6ccd308bde43eca3744f2a87138dabbb884e8300a06082a8648ce3d0403023053310b30090603550406130255533111300f06035504080c084e657720596f726b310f300d06035504070c06416c62616e79310f300d060355040a0c064e5920444d56310f300d060355040b0c064e5920444d56301e170d3233303931343134353531385a170d3333303931313134353531385a3053310b30090603550406130255533111300f06035504080c084e657720596f726b310f300d06035504070c06416c62616e79310f300d060355040a0c064e5920444d56310f300d060355040b0c064e5920444d563059301306072a8648ce3d020106082a8648ce3d03010703420004893c2d8347906dc6cd69b7f636af4bfd533f96184f0aadacd10830da4471dbdb60ac170d1cfc534fae2d9dcd488f7747fdf978d925ea31e9e9083c382ba9ed53a38181307f301d0603551d0e04160414ab6d2e03b91d492240338fbccadefd9333eaf6c7301f0603551d23041830168014ab6d2e03b91d492240338fbccadefd9333eaf6c7300f0603551d130101ff040530030101ff302c06096086480186f842010d041f161d4f70656e53534c2047656e657261746564204365727469666963617465300a06082a8648ce3d0403020348003045022009fd0cab97b03e78f64e74d7dcee88668c476a0afc5aa2cebffe07d3be772ea9022100da38abc98a080f49f24ffece1fffc8a6cdd5b2c0b5da8fc7b767ac3a95dcb83e04643132333459018cd818590187a66776657273696f6e63312e306f646967657374416c676f726974686d675348412d3235366c76616c756544696765737473a1756f72672e69736f2e31383031332e352e312e6d444ca11a9bdb724958203ff255af75e35ed42f7a48a2f410203baa3b93cb48e88a8b870fa320f4a6480d6d6465766963654b6579496e666fa1696465766963654b6579a5613102622d3101622d325820881879ca7a238b19bf0f4c1f8c00e9a2e19ba7a6f73eae92b851d4de1b508559622d335820a314b538039127b5cd50735f54519e33c134450545c5603ad9f263facc56d377622d345820791a4066bdde579c4c3273c6de45a383dd18f9b05f7fd2ea9a542e938f4752d067646f6354797065716f72672e69736f2e31383031332e352e316c76616c6964697479496e666fa3667369676e6564c074323032332d31302d32345431343a35353a31385a6976616c696446726f6dc074323032332d31302d32345431353a30303a31385a6a76616c6964556e74696cc074323035332d31302d32345431343a35353a31385a5840a2e247bf5d8b2cff4774c09da492e7cfda434a87ab608c1b0da9fbe9ba5ddea778fef225551f82dd5c4f771bf5c1de2df24d5c65de1059ba292bac945c99c8e8'
    )

    expect(issuerSigned.encodedForOid4Vci).toStrictEqual(
      'ompuYW1lU3BhY2VzoXVvcmcuaXNvLjE4MDEzLjUuMS5tREyC2BhYaKRoZGlnZXN0SUQam9tySWZyYW5kb21YIJvbckmJZ4ZXEBCK9DlZ-QwbaqyWh77dH6U90NIQP6XQcWVsZW1lbnRJZGVudGlmaWVyamZpcnN0X25hbWVsZWxlbWVudFZhbHVlZUZpcnN02BhYZqRoZGlnZXN0SUQam9tySWZyYW5kb21YIJvbckmJZ4ZXEBCK9DlZ-QwbaqyWh77dH6U90NIQP6XQcWVsZW1lbnRJZGVudGlmaWVyaWxhc3RfbmFtZWxlbGVtZW50VmFsdWVkTGFzdGppc3N1ZXJBdXRohEOhASaiGCFZAi4wggIqMIIB0KADAgECAhRXxszTCL3kPso3RPKocTjau7iE6DAKBggqhkjOPQQDAjBTMQswCQYDVQQGEwJVUzERMA8GA1UECAwITmV3IFlvcmsxDzANBgNVBAcMBkFsYmFueTEPMA0GA1UECgwGTlkgRE1WMQ8wDQYDVQQLDAZOWSBETVYwHhcNMjMwOTE0MTQ1NTE4WhcNMzMwOTExMTQ1NTE4WjBTMQswCQYDVQQGEwJVUzERMA8GA1UECAwITmV3IFlvcmsxDzANBgNVBAcMBkFsYmFueTEPMA0GA1UECgwGTlkgRE1WMQ8wDQYDVQQLDAZOWSBETVYwWTATBgcqhkjOPQIBBggqhkjOPQMBBwNCAASJPC2DR5Btxs1pt_Y2r0v9Uz-WGE8KrazRCDDaRHHb22CsFw0c_FNPri2dzUiPd0f9-XjZJeox6ekIPDgrqe1To4GBMH8wHQYDVR0OBBYEFKttLgO5HUkiQDOPvMre_ZMz6vbHMB8GA1UdIwQYMBaAFKttLgO5HUkiQDOPvMre_ZMz6vbHMA8GA1UdEwEB_wQFMAMBAf8wLAYJYIZIAYb4QgENBB8WHU9wZW5TU0wgR2VuZXJhdGVkIENlcnRpZmljYXRlMAoGCCqGSM49BAMCA0gAMEUCIAn9DKuXsD549k5019zuiGaMR2oK_Fqizr_-B9O-dy6pAiEA2jiryYoID0nyT_7OH__Ips3VssC12o_Ht2esOpXcuD4EZDEyMzRZAYzYGFkBh6ZndmVyc2lvbmMxLjBvZGlnZXN0QWxnb3JpdGhtZ1NIQS0yNTZsdmFsdWVEaWdlc3RzoXVvcmcuaXNvLjE4MDEzLjUuMS5tREyhGpvbcklYID_yVa91417UL3pIovQQIDuqO5PLSOiKi4cPoyD0pkgNbWRldmljZUtleUluZm-haWRldmljZUtleaVhMQJiLTEBYi0yWCCIGHnKeiOLGb8PTB-MAOmi4Zunpvc-rpK4UdTeG1CFWWItM1ggoxS1OAORJ7XNUHNfVFGeM8E0RQVFxWA62fJj-sxW03diLTRYIHkaQGa93lecTDJzxt5Fo4PdGPmwX3_S6ppULpOPR1LQZ2RvY1R5cGVxb3JnLmlzby4xODAxMy41LjFsdmFsaWRpdHlJbmZvo2ZzaWduZWTAdDIwMjMtMTAtMjRUMTQ6NTU6MThaaXZhbGlkRnJvbcB0MjAyMy0xMC0yNFQxNTowMDoxOFpqdmFsaWRVbnRpbMB0MjA1My0xMC0yNFQxNDo1NToxOFpYQKLiR79diyz_R3TAnaSS58_aQ0qHq2CMGw2p--m6Xd6neP7yJVUfgt1cT3cb9cHeLfJNXGXeEFm6KSuslFyZyOg'
    )
  })

  test('Issue mdoc with multiple namespaces', async () => {
    const issuer = new Issuer('org.iso.18013.5.1', deterministicMdocContext)

    issuer.addIssuerNamespace('org.iso.18013.5.1.mDL', {
      first_name: 'First',
      last_name: 'Last',
    })

    issuer.addIssuerNamespace('org.iso.18013.5.1.second', {
      street: 'my street',
      number: '1233',
    })

    const issuerSigned = await issuer.sign({
      signingKey: CoseKey.fromJwk(ISSUER_PRIVATE_KEY_JWK),
      certificate: new Uint8Array(new X509Certificate(ISSUER_CERTIFICATE).rawData),
      algorithm: SignatureAlgorithm.ES256,
      digestAlgorithm: 'SHA-256',
      deviceKeyInfo: { deviceKey: CoseKey.fromJwk(DEVICE_JWK) },
      validityInfo: { signed, validFrom, validUntil },
    })

    const mdlClaims = issuerSigned.getPrettyClaims('org.iso.18013.5.1.mDL')
    const secondClaims = issuerSigned.getPrettyClaims('org.iso.18013.5.1.second')

    expect(mdlClaims).toMatchObject({
      first_name: 'First',
      last_name: 'Last',
    })

    expect(secondClaims).toMatchObject({
      street: 'my street',
      number: '1233',
    })

    expect(hex.encode(issuerSigned.encode())).toStrictEqual(
      'a26a6e616d65537061636573a2756f72672e69736f2e31383031332e352e312e6d444c82d8185868a46864696765737449441a9bdb72496672616e646f6d58209bdb72498967865710108af43959f90c1b6aac9687bedd1fa53dd0d2103fa5d071656c656d656e744964656e7469666965726a66697273745f6e616d656c656c656d656e7456616c7565654669727374d8185866a46864696765737449441a9bdb72496672616e646f6d58209bdb72498967865710108af43959f90c1b6aac9687bedd1fa53dd0d2103fa5d071656c656d656e744964656e746966696572696c6173745f6e616d656c656c656d656e7456616c7565644c61737478186f72672e69736f2e31383031332e352e312e7365636f6e6482d8185868a46864696765737449441a9bdb72496672616e646f6d58209bdb72498967865710108af43959f90c1b6aac9687bedd1fa53dd0d2103fa5d071656c656d656e744964656e746966696572667374726565746c656c656d656e7456616c7565696d7920737472656574d8185863a46864696765737449441a9bdb72496672616e646f6d58209bdb72498967865710108af43959f90c1b6aac9687bedd1fa53dd0d2103fa5d071656c656d656e744964656e746966696572666e756d6265726c656c656d656e7456616c756564313233336a697373756572417574688443a10126a2182159022e3082022a308201d0a003020102021457c6ccd308bde43eca3744f2a87138dabbb884e8300a06082a8648ce3d0403023053310b30090603550406130255533111300f06035504080c084e657720596f726b310f300d06035504070c06416c62616e79310f300d060355040a0c064e5920444d56310f300d060355040b0c064e5920444d56301e170d3233303931343134353531385a170d3333303931313134353531385a3053310b30090603550406130255533111300f06035504080c084e657720596f726b310f300d06035504070c06416c62616e79310f300d060355040a0c064e5920444d56310f300d060355040b0c064e5920444d563059301306072a8648ce3d020106082a8648ce3d03010703420004893c2d8347906dc6cd69b7f636af4bfd533f96184f0aadacd10830da4471dbdb60ac170d1cfc534fae2d9dcd488f7747fdf978d925ea31e9e9083c382ba9ed53a38181307f301d0603551d0e04160414ab6d2e03b91d492240338fbccadefd9333eaf6c7301f0603551d23041830168014ab6d2e03b91d492240338fbccadefd9333eaf6c7300f0603551d130101ff040530030101ff302c06096086480186f842010d041f161d4f70656e53534c2047656e657261746564204365727469666963617465300a06082a8648ce3d0403020348003045022009fd0cab97b03e78f64e74d7dcee88668c476a0afc5aa2cebffe07d3be772ea9022100da38abc98a080f49f24ffece1fffc8a6cdd5b2c0b5da8fc7b767ac3a95dcb83e0464313233345901ced8185901c9a66776657273696f6e63312e306f646967657374416c676f726974686d675348412d3235366c76616c756544696765737473a2756f72672e69736f2e31383031332e352e312e6d444ca11a9bdb724958203ff255af75e35ed42f7a48a2f410203baa3b93cb48e88a8b870fa320f4a6480d78186f72672e69736f2e31383031332e352e312e7365636f6e64a11a9bdb724958209cd66984703d6115311074ba997b262f8382c1d17c0300670734ae3b4ad9dbcd6d6465766963654b6579496e666fa1696465766963654b6579a5613102622d3101622d325820881879ca7a238b19bf0f4c1f8c00e9a2e19ba7a6f73eae92b851d4de1b508559622d335820a314b538039127b5cd50735f54519e33c134450545c5603ad9f263facc56d377622d345820791a4066bdde579c4c3273c6de45a383dd18f9b05f7fd2ea9a542e938f4752d067646f6354797065716f72672e69736f2e31383031332e352e316c76616c6964697479496e666fa3667369676e6564c074323032332d31302d32345431343a35353a31385a6976616c696446726f6dc074323032332d31302d32345431353a30303a31385a6a76616c6964556e74696cc074323035332d31302d32345431343a35353a31385a5840011158fa68dc3cabba32df27a7de695b34437f9a01a0bb7a74adfcdae85d903a204af39769982eb9ee128b6865cbadc151c5c9f8e8e4d75516d8f5ab981a6531'
    )

    expect(issuerSigned.encodedForOid4Vci).toStrictEqual(
      'ompuYW1lU3BhY2VzonVvcmcuaXNvLjE4MDEzLjUuMS5tREyC2BhYaKRoZGlnZXN0SUQam9tySWZyYW5kb21YIJvbckmJZ4ZXEBCK9DlZ-QwbaqyWh77dH6U90NIQP6XQcWVsZW1lbnRJZGVudGlmaWVyamZpcnN0X25hbWVsZWxlbWVudFZhbHVlZUZpcnN02BhYZqRoZGlnZXN0SUQam9tySWZyYW5kb21YIJvbckmJZ4ZXEBCK9DlZ-QwbaqyWh77dH6U90NIQP6XQcWVsZW1lbnRJZGVudGlmaWVyaWxhc3RfbmFtZWxlbGVtZW50VmFsdWVkTGFzdHgYb3JnLmlzby4xODAxMy41LjEuc2Vjb25kgtgYWGikaGRpZ2VzdElEGpvbcklmcmFuZG9tWCCb23JJiWeGVxAQivQ5WfkMG2qsloe-3R-lPdDSED-l0HFlbGVtZW50SWRlbnRpZmllcmZzdHJlZXRsZWxlbWVudFZhbHVlaW15IHN0cmVldNgYWGOkaGRpZ2VzdElEGpvbcklmcmFuZG9tWCCb23JJiWeGVxAQivQ5WfkMG2qsloe-3R-lPdDSED-l0HFlbGVtZW50SWRlbnRpZmllcmZudW1iZXJsZWxlbWVudFZhbHVlZDEyMzNqaXNzdWVyQXV0aIRDoQEmohghWQIuMIICKjCCAdCgAwIBAgIUV8bM0wi95D7KN0TyqHE42ru4hOgwCgYIKoZIzj0EAwIwUzELMAkGA1UEBhMCVVMxETAPBgNVBAgMCE5ldyBZb3JrMQ8wDQYDVQQHDAZBbGJhbnkxDzANBgNVBAoMBk5ZIERNVjEPMA0GA1UECwwGTlkgRE1WMB4XDTIzMDkxNDE0NTUxOFoXDTMzMDkxMTE0NTUxOFowUzELMAkGA1UEBhMCVVMxETAPBgNVBAgMCE5ldyBZb3JrMQ8wDQYDVQQHDAZBbGJhbnkxDzANBgNVBAoMBk5ZIERNVjEPMA0GA1UECwwGTlkgRE1WMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEiTwtg0eQbcbNabf2Nq9L_VM_lhhPCq2s0Qgw2kRx29tgrBcNHPxTT64tnc1Ij3dH_fl42SXqMenpCDw4K6ntU6OBgTB_MB0GA1UdDgQWBBSrbS4DuR1JIkAzj7zK3v2TM-r2xzAfBgNVHSMEGDAWgBSrbS4DuR1JIkAzj7zK3v2TM-r2xzAPBgNVHRMBAf8EBTADAQH_MCwGCWCGSAGG-EIBDQQfFh1PcGVuU1NMIEdlbmVyYXRlZCBDZXJ0aWZpY2F0ZTAKBggqhkjOPQQDAgNIADBFAiAJ_Qyrl7A-ePZOdNfc7ohmjEdqCvxaos6__gfTvncuqQIhANo4q8mKCA9J8k_-zh__yKbN1bLAtdqPx7dnrDqV3Lg-BGQxMjM0WQHO2BhZAcmmZ3ZlcnNpb25jMS4wb2RpZ2VzdEFsZ29yaXRobWdTSEEtMjU2bHZhbHVlRGlnZXN0c6J1b3JnLmlzby4xODAxMy41LjEubURMoRqb23JJWCA_8lWvdeNe1C96SKL0ECA7qjuTy0joiouHD6Mg9KZIDXgYb3JnLmlzby4xODAxMy41LjEuc2Vjb25koRqb23JJWCCc1mmEcD1hFTEQdLqZeyYvg4LB0XwDAGcHNK47StnbzW1kZXZpY2VLZXlJbmZvoWlkZXZpY2VLZXmlYTECYi0xAWItMlggiBh5ynojixm_D0wfjADpouGbp6b3Pq6SuFHU3htQhVliLTNYIKMUtTgDkSe1zVBzX1RRnjPBNEUFRcVgOtnyY_rMVtN3Yi00WCB5GkBmvd5XnEwyc8beRaOD3Rj5sF9_0uqaVC6Tj0dS0Gdkb2NUeXBlcW9yZy5pc28uMTgwMTMuNS4xbHZhbGlkaXR5SW5mb6Nmc2lnbmVkwHQyMDIzLTEwLTI0VDE0OjU1OjE4Wml2YWxpZEZyb23AdDIwMjMtMTAtMjRUMTU6MDA6MThaanZhbGlkVW50aWzAdDIwNTMtMTAtMjRUMTQ6NTU6MThaWEABEVj6aNw8q7oy3yen3mlbNEN_mgGgu3p0rfza6F2QOiBK85dpmC657hKLaGXLrcFRxcn46OTXVRbY9auYGmUx'
    )
  })
})
